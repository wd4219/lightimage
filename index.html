<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>lightimage</title>
  <link rel="stylesheet" href="./styles/index.css">
  <link rel="stylesheet" href="./styles/normalize.css">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_863778_rwhxdwkvgq.css">
</head>

<body>
  <div class="title-bar">lightimage
    <div class="right-tool">
      <span class="iconfont icon-min"></span>
      <span class="iconfont icon-max"></span>
      <span class="iconfont icon-close"></span>
    </div>
  </div>
  <div class="img-list-container">
    <ul class="img-list" ondrop="drop(event)" ondragover="allowDrop(event)">
      <!-- <li class="img-list-item">
        <div class="thumb">
          <img src="./images/red_like.png" alt="缩略图">
        </div>
        <div class="content">
          <div class="filename">
            red_like.png
          </div>
          <div class="text">
            <div class="new-size">
              10.2KB
            </div>
            <div class="separator">/</div>            
            <div class="old-size">
              20.3KB
            </div>
            <div class="compression-ratio">
              50%
            </div>
          </div>
        </div>
        <div class="btn-box">
          <div class="base64">
            <i class="iconfont icon-base64" title="base64"></i>
          </div>
          <div class="compare">
            <i class="iconfont icon-compare" title="对比"></i>
          </div>
          <div class="location">
            <i class="iconfont icon-location" title="定位"></i>
          </div>
        </div>
      </li> -->
      <div class="drag-box">
        <p>请将图片拖入窗口中<br>（支持JPG PNG GIF格式）</p>
        <i class="iconfont icon-image"></i>
      </div>
    </ul>
    
  </div>
  <script>
    const ipcRenderer = require('electron').ipcRenderer;
    const shell = require('electron').shell;
    const dialog = require('electron').dialog;
    const fs = require('fs');
    const path = require('path');
    const base64Img = require('base64-img');
    const imagemin = require('imagemin');
    const imageminPngquant = require('imagemin-pngquant');
    const imageminMozjpeg = require('imagemin-mozjpeg');
    const imageminGifsicle = require('imagemin-gifsicle');
    const shortid = require('shortid');
    const glob = require('glob');
    window.$ = window.jQuery = require('./jquery.min.js');
    ipcRenderer.on('filepaths', function (event, files) {
      let filePaths = getFilePaths(files);
      generateImage(filePaths);
    });
    $('.img-list').on('click','.location',function(e){
      let path = $(this).data('path');
      shell.showItemInFolder(path);
    });
    $('.right-tool .iconfont').click(function(){
      let index = $(this).index();
      if(index === 1) {
        if($(this).hasClass('icon-max')){
          $(this).removeClass('icon-max').addClass('icon-reset');
        } else {
          $(this).removeClass('icon-reset').addClass('icon-max');
        }
      }
      ipcRenderer.send('window',index);
    });
    $('.img-list').on('click', '.base64',function(e){
      let path = $(this).data('path');
      base64Img.base64(path, function(err, data) {
        if(err){
          alert('出错了');
        } else {
          ipcRenderer.send('base64',data);
          console.log(data);
        }
      });
    });

    function allowDrop(event){
      event.preventDefault();
    }
    function drop(event){
      let files = [];
      for(let i = 0; i < event.dataTransfer.files.length;i++) {
        files.push(event.dataTransfer.files[i].path);
      }
      let filePaths = getFilePaths(files);
      generateImage(filePaths);
    }

    function getFilePaths(fileArray) {
      let filePaths = [];
      for(let i = 0; i < fileArray.length;i++) {
        let stat = fs.statSync(fileArray[i]);
        if(stat.isDirectory()){
          let files = glob.sync(path.join(fileArray[i],"**/**"),{matchBase: true});
          let imageFiles = files.filter(function(item){
            return /\.(png|jpg|gif)$/.test(item)
          });
          filePaths.push(...imageFiles);
        } else {
          if(/\.(png|jpg|gif)$/.test(fileArray[i])){
            filePaths.push(fileArray[i]);
          } else {
            console.log('拖入的存在非图片格式文件');
          }
        }
      }
      return filePaths;
    }

    function generateImage(filePaths) {
      let html = '';
      filePaths.forEach(function(item){
        let filename = path.basename(item);
        let file = {
          name: filename,
          path: item
        };
        fs.stat(item, function(err,data){
          file.size = data.size >= 1024 ? (data.size / 1024).toFixed(1) + 'KB' : data.size + 'B';
          let id = shortid.generate();
          if(file) {
            html = `
            <li class="img-list-item" id="${id}">
              <div class="thumb">
                <img src="${file.path}" alt="缩略图">
              </div>
              <div class="content">
                <div class="filename">
                  ${file.name}
                </div>
                <div class="text">
                  <div class="old-size">
                    ${file.size}
                  </div>
                  <div class="separator">/</div>            
                  <div class="new-size">
                  </div>
                  <div class="compression-ratio">
                    <i class="iconfont icon-reduct"></i>
                  </div>
                </div>
              </div>
              <div class="btn-box">
                <div class="base64">
                  <i class="iconfont icon-base64" title="base64"></i>
                </div>
                <div class="compare">
                  <i class="iconfont icon-compare" title="对比" data-path="${file.path}"></i>
                </div>
                <div class="location">
                  <i class="iconfont icon-location" title="定位"></i>
                </div>
              </div>
            </li>
            `;
            $('.img-list').append(html);
            $('.drag-box').hide();
          }
          imagemin([item], path.dirname(item), {use: [imageminMozjpeg(),imageminPngquant({quality: '65-80'}),imageminGifsicle()]}).then((files) => {
            $('#'+ id + ' .new-size').text(files[0].data.length >= 1024 ? (files[0].data.length / 1024).toFixed(1) + 'KB' : files[0].data.length + 'B');
            let ratio = ((data.size - files[0].data.length) / data.size).toFixed(2) * 100 + '%'
            $('#'+ id + ' .compression-ratio').text(ratio);
            $('#'+ id + ' .base64').data('path',item);
            $('#'+ id + ' .location').data('path',item);
            $('#'+ id + ' .compression-ratio').html(`<i class="iconfont icon-reduce"></i>${ratio}`);
          });
        });
      });
    }
    $('.img-list').on('click','.img-list-item',function(){
      $(this).addClass('active').siblings().removeClass('active');
    });
  </script>
</body>

</html>